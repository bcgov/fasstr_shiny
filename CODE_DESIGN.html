<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Code Design • fasstrshiny</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css"><script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="pkgdown.js"></script><meta property="og:title" content="Code Design"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-title-body">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">fasstrshiny</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="inst/md/overview.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="inst/md/overview.html">Get Started</a>
</li>
<li>
  <a href="inst/md/overview2.html">User Guide</a>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/bcgov/fasstrshiny" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>Code Design</h1>
    </div>

<div id="code-design" class="section level1">
<p>This document records general code-design related decisions in an effort to simplify future development.</p>
<p>Much of the design of fasstrshiny is related to the design of fasstr, which has a series of functions following similar naming conventions and with similar arguments.</p>
<p>Most sections of fasstrshiny related to families of functions within fasstr.</p>
<div class="section level2">
<h2 id="organization">Organization<a class="anchor" aria-label="anchor" href="#organization"></a></h2>
<p>Each panel of the app has corresponding module functions in a file named <code>mod_XXX.R</code>. Interactively built UI elements are at the <em>top</em> of server functions. Anything pertaining to modifying the UI (toggles, updates, bookmarking) are also in this section.</p>
<p>Non-interactively built UI elements are in their corresponding section in the ui function. Functions for building commonly used inputs are in the helper_ui_inputs.R script. Other functions can be found in <code>helper_XXX.R</code> files.</p>
<p>The <code>fasster_shiny()</code> function combines all modules into a single app. Note that each section needs to be created in the menu, the UI tabsets AND the server section.</p>
</div>
<div class="section level2">
<h2 id="namespace">Namespace<a class="anchor" aria-label="anchor" href="#namespace"></a></h2>
<p>Because modules create their own ids, we need to use the <code>NS()</code> function to ensure that module ids are unique. In the UI functions, we use <code>ns &lt;- NS(id)</code> at the top of the function. Then we can use <code>ns("my_input")</code> throughout.</p>
<p>However, for server functions, we need to use <code>NS(id, "my_input")</code> directly.</p>
<p>For functions that create UI inputs, the <code>NS(id, ...)</code> is inside the function, so in the UI (or Server) function you would only pass the id: <code>select_rolling(id)</code>.</p>
</div>
<div class="section level2">
<h2 id="inputs-and-ids">Inputs and IDs<a class="anchor" aria-label="anchor" href="#inputs-and-ids"></a></h2>
<p>Many inputs are the same among sections in fasstrshiny because they related to arguments in fasstr which are common among function families.</p>
<p>To ensure consistency, functions (<code>select_XXXX()</code>) are used to create inputs for each section. These functions create separate instances of the inputs, with unique ids, but which are consistent.</p>
<p>For example, <code>select_rolling(id)</code> creates inputs <code>ID_roll_days</code> (numeric input) and <code>ID_rolling_align</code> (select input).</p>
<p>Interactively built inputs need to be created in the server functions under “UI elements” before they can be referenced in the ui with <code>uiOutput()</code>.</p>
<p>For IDs, see the internal dataset, <code>parameters</code>. It is created in <code>data-raw/parameters.R</code> and includes parameter <code>id</code>s, <code>tooltips</code> and how they correspond to fasstr arguments.</p>
</div>
<div class="section level2">
<h2 id="bookmarking">Bookmarking<a class="anchor" aria-label="anchor" href="#bookmarking"></a></h2>
<p>Bookmarking is URL-based on shinyapps.io and Server-based (i.e. saving a file to the computer) on locally-run instances of <code>fasstrshiny</code>.</p>
<p>Bookmarking only applies to the full GUI run with <code><a href="reference/fasstr_shiny.html">fasstr_shiny()</a></code>. It automatically saves the state of all inputs. However, by default, bookmarking doesn’t save the state of <em>dynamically-created inputs</em>. These inputs must be saved by hand using the <code>onBookmark()</code> function and then restored by hand using the <code>onRestored()</code> function. The internal helper function <code>restore_inputs</code> defines how to restore the inputs.</p>
<p>If creating a new module with dynamic inputs,</p>
<ol style="list-style-type: lower-alpha"><li><p>Make sure you have a section for saving and restoring these inputs (see <code>mod_annual_trends.R</code> at the end of the “UI Elements” section for an example);</p></li>
<li><p>Ensure the input ids <em>and</em> types exist in the <code>restore_inputs()</code> function, if they do not, you’ll have to add them (see documentation for <code>restore_inputs()</code> in the <code>helper_shiny.R</code> file for details).</p></li>
</ol><p>Note that not <em>every</em> dynamic input needs to be bookmarked. For example, it is probably unnecessary to bookmark which plot is currently being displayed. The default value is most likely sufficient.</p>
</div>
<div class="section level2">
<h2 id="creating-fasstr-functions">Creating fasstr functions<a class="anchor" aria-label="anchor" href="#creating-fasstr-functions"></a></h2>
<p>fasstrshiny includes functions for assembling fasstr functions based on user input in an effort to minimize the need for massive if/else chains and to create a code record to share with the user (in “R Code” tabs).</p>
<p>One of the main ideas in fasstrshiny is to share the code used to create the output with the user. To ensure that the output is always consistent with the code used in the app, all main fasstr functions are assembled as a text object and then evaluated. The text version can be used in the R Code panels, and the evaluated version used to create the shiny app outputs.</p>
<p>For example, <code>create_fun()</code> takes the name of the fasstr function, the name of the dataset, the shiny <code>input</code> object, and data settings. It then matches inputs in that module against parameters in the fasstr function, omits those that have default values, and creates a <em>text</em> version of the fasstr function with arguments.</p>
<p>Example from hydrograph figure:</p>
<pre><code><span class="va">data_flow</span> <span class="op">&lt;-</span> <span class="fu">data_raw</span><span class="op">(</span><span class="op">)</span>

<span class="va">g</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">type</span>,
            <span class="st">"Daily"</span> <span class="op">=</span> <span class="st">"plot_daily_stats"</span>,
            <span class="st">"Long-term Monthly"</span> <span class="op">=</span> <span class="st">"plot_longterm_monthly_stats"</span>,
            <span class="st">"Long-term Daily"</span> <span class="op">=</span> <span class="st">"plot_longterm_daily_stats"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">create_fun</span><span class="op">(</span>data_name <span class="op">=</span> <span class="st">"data_flow"</span>, <span class="va">input</span>, input_data <span class="op">=</span> <span class="fu">data_settings</span><span class="op">(</span><span class="op">)</span>,
             extra <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span>
               <span class="va">input</span><span class="op">$</span><span class="va">add_year</span> <span class="op">!=</span> <span class="st">""</span>,
               <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"add_year = {input$add_year}"</span><span class="op">)</span>,
               <span class="st">""</span><span class="op">)</span><span class="op">)</span></code></pre>
<p>Example <em>text</em> output:</p>
<pre><code><span class="fu">plot_daily_stats</span><span class="op">(</span><span class="va">data_flow</span>,
  values <span class="op">=</span> <span class="st">"Value"</span>,
  start_year <span class="op">=</span> <span class="fl">1972</span>,
  end_year <span class="op">=</span> <span class="fl">2019</span>,
  ignore_missing <span class="op">=</span> <span class="cn">TRUE</span>,
  add_year <span class="op">=</span> <span class="fl">2013</span>
<span class="op">)</span></code></pre>
<p>This can be saved for sharing with the user through the R Code panel, and can then be parsed and evaluated with <code>eval_check(t)</code>, a function which evaluates the text code and checks for errors.</p>
<p><strong>Adding new arguments</strong></p>
<p>New arguments can be added in one of two ways. If an argument is used in a standard way, it’s name/id can be added to the <code>parameters</code> data frame created in <code>data-raw/parameters.R</code> and then how to use it in a function can be added to the workflow in the <code>combine_parameters()</code> function. As long as the input id is called <code>param</code>, id of the parameter in this shiny app, it will be automatically used by <code>create_fun()</code>, unless added to the <code>params_ignore</code> list.</p>
<p>Alternatively if an argument is used in a non-standard way, it can be added with the <code>extra</code> argument. You’ll also need to add it to <code>params_ignore</code> so as not to have two arguments in the final function.</p>
<p>For example, in the Hydrographs table, we use percentiles from several inputs (previously combined into <code>perc</code> in this example), so override the default usage of the percentiles argument.</p>
<pre><code><span class="va">t</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">hydro_type</span>,
            <span class="st">"Long-term Daily"</span> <span class="op">=</span> <span class="st">"calc_longterm_daily_stats"</span>,
            <span class="st">"Long-term Monthly"</span> <span class="op">=</span> <span class="st">"calc_longterm_monthly_stats"</span>,
            <span class="st">"Daily"</span> <span class="op">=</span> <span class="st">"calc_daily_stats"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">create_fun</span><span class="op">(</span>
    <span class="st">"data_flow"</span>, id <span class="op">=</span> <span class="st">"hydro"</span>, <span class="va">input</span>,
    <span class="co"># Because input$hydro_percentiles exists, but we don't want to use it</span>
    params_ignore <span class="op">=</span> <span class="st">"percentiles"</span>,
    extra <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"percentiles = c({glue_collapse(perc, sep = ', ')})"</span><span class="op">)</span><span class="op">)</span></code></pre>
<p>NOTE: If adding a new <em>dynamic</em> input, ensure that it is captured by bookmarking. (See Bookmarking above).</p>
</div>
<div class="section level2">
<h2 id="displaying-code">Displaying Code<a class="anchor" aria-label="anchor" href="#displaying-code"></a></h2>
<p>The <code>create_fun()</code> function creates a text version of the code to run, allowing us to save that for displaying in the R Code tab.</p>
<p>To catch the code, you need to assign it and a label to <code>code$NAME</code> and <code>labels$NAME</code> respectively. By default code named <code>data_raw</code> (raw flow data passed to module, never created manually), <code>data</code> (any data created by module), <code>plot</code>, and <code>table</code>, are placed in the R Code tab in that order. If you have other (or more) bits of code, you need to assign the order in the <code>code_format()</code> function used at the end of each <code>server_XXX()</code> function. See <code>mod_hydro.R</code> for an example.</p>
<p>After you have captured the code, you can then use the <code>eval_check()</code> function to check and evaluate the code for use as an output.</p>
</div>
<div class="section level2">
<h2 id="adding-a-new-module">Adding a new module<a class="anchor" aria-label="anchor" href="#adding-a-new-module"></a></h2>
<ul><li>Create new <code>mod_XXX.R</code> file with UI and server functions</li>
<li>In <code><a href="reference/fasstr_shiny.html">fasstr_shiny()</a></code>,<ul><li>add <code>ui_XXX()</code> function to the UI function,</li>
<li>add reference to the sidebar function,</li>
<li>add name (<code>XXX</code>) to the <code>mods</code> list in <code>data-raw/parameters.R</code>, re-run this file</li>
</ul></li>
<li>In the <code>server_XXX()</code> function, use <code>create_fun()</code> in the appropriate output or reactive<ul><li>Add inputs for the values which are NOT set in data_settings() (see bottom of <code>mod_data_load.R</code>)</li>
<li>
<code>data_settings()</code> values will <em>automatically</em> be used in the function. If any should not (i.e. <code>discharge</code> is use to set <code>value</code> to a different flow type column like yield or volume, but this isn’t always appropriate), add the parameter to the argument <code>params_ignore</code>.</li>
<li>Add new arguments to<ul><li>the <code>parameters</code> list in <code>data-raw/parameters.R</code>
</li>
<li>the <code>combine_parameters.R</code> function in <code>helper_create_fun.R</code>
</li>
</ul></li>
<li>New arguments that aren’t standard (i.e. <code>percentiles</code> in <code>mod_hydro.R</code>) can be added via the <code>extra</code> argument</li>
<li>
<strong>If new inputs are created dynamically, ensure they are saved during bookmarking.</strong> Add new types of inputs to <code>restore_inputs()</code> in <code>helper_shiny.R</code> (see <code>mod_hydro.R</code> for example). If a compute button is required, ensure it is <strong>NOT</strong> bookmarked (see <code>mod_annual_trends.R</code> for example)</li>
</ul></li>
<li>Store the code created by <code>create_fun()</code> and a title for this code in <code>code$NAME</code> and <code>labels$NAME</code> respectively (adjust order as needed, see Code above)</li>
<li>Use <code>eval_check()</code> to check and evaluate (i.e. run) the code you created</li>
<li>Add tests to <code>test_mod.R</code>, make sure every input gets a starting value</li>
</ul></div>
<div class="section level2">
<h2 id="miscellaneous-points">Miscellaneous points<a class="anchor" aria-label="anchor" href="#miscellaneous-points"></a></h2>
<div class="section level3">
<h3 id="datatables">Datatables<a class="anchor" aria-label="anchor" href="#datatables"></a></h3>
<ul><li>With the scroller extension, must use the scrollY attribute to set table height (can’t use pageLength)</li></ul></div>
<div class="section level3">
<h3 id="missing-vs-allowed-missing">Missing vs. Allowed missing<a class="anchor" aria-label="anchor" href="#missing-vs-allowed-missing"></a></h3>
<ul><li>If <code>allowed_missing</code> exists, use only that (it overrides <code>ignore_missing</code> anyway)</li></ul></div>
<div class="section level3">
<h3 id="ggiraph"><code>ggiraph</code><a class="anchor" aria-label="anchor" href="#ggiraph"></a></h3>
<ul><li>Always use <code>girafe</code>, <code>girafeOutput</code> and <code>renderGirafe</code> (not any of the ggiraph variants)</li>
<li>Always use <code>girafe(ggobj = PLOT)</code> (<code>ggobj</code> is the important argument here)</li>
<li>When using the vline tooltip (<code>create_vline_interactive()</code>) you’ll need to adjust the <code>opts_hover()</code> option in the girafe output to make opacity 1.</li>
<li>Plot height (for most plots) is set in the UI with the option opts$plot_height. This is set in the <code>data-raw/parameters.R</code> script (re-run this script after any changes)</li>
</ul></div>
<div class="section level3">
<h3 id="spinners">Spinners<a class="anchor" aria-label="anchor" href="#spinners"></a></h3>
<p>Spinners are created with the <code>shinycssloaders</code> package. The global options are set in <code>global.R</code>. Every output that requires a progress spinner needs to be wrapped with <code>withSpinner()</code> in <code>ui.R</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a></h2>
<ul><li>Input/output doesn’t render, no message, no error<ul><li>Check to make sure id isn’t duplicated</li>
<li>Check to make sure all the ids match up (i.e. same id, no spelling mistakes)</li>
</ul></li>
<li>Data Loading only shows one station on the map<ul><li>Testing using only a small HYDAT stations subset, so if you are testing interactively, this is the data set you’ll use.</li>
<li>Re-load R and try again.</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="test-errors">Test errors<a class="anchor" aria-label="anchor" href="#test-errors"></a></h2>
<p>For a testthat error like:</p>
<p><code>Failure (test_04d_modules_analysis.R:59:3): Hydat Peak</code>output<span class="math inline">$table` threw an unexpected error. Message: The test referenced an output that hasn't been defined yet: output$</span>proxy1-table`</p>
<ul><li><p>Look at line 59 in the <code>test_04d_modules_analysis.R</code> file, this is the test that is failing.</p></li>
<li><p>“<code>output$table</code> threw an unexpected error” means that when testing <code>expect_error(output$table, NA)</code> (which means DON’T expect an error), there was an error</p></li>
<li><p>"Message: The test referenced an output that hasn’t been defined yet: output$proxy1-table<code>" means that the error returned refers to the fact that the</code>table<code>object hasn't  been rendered in the test Shiny server. This is why the test is failing. (Note that</code>proxy1-<code>is simply the id assigned to the namespace by</code>testServer()<code>,  the important part is the</code>table`, which tells you which object is causing problems).</p></li>
<li>
<p>Check the following:</p>
<ul><li>Is the output actually called <code>table</code>? (Was it changed? Is there a typo?)</li>
<li>Should the output actually be rendered by this point? Or does it need another input, or a button click? If so, add that to <code>session$setInputs()</code>
</li>
<li>Remember that <em>every</em> input needs to be defined in each test.</li>
</ul></li>
<li><p>You can add a <code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> call inside the <code>testServer()</code> function if you need to do more thorough testing (see Mastering Shiny’s section on Testing reactivitity <a href="https://mastering-shiny.org/scaling-testing.html#testing-reactivity" class="external-link uri">https://mastering-shiny.org/scaling-testing.html#testing-reactivity</a>)</p></li>
</ul></div>
<div class="section level2">
<h2 id="tips">Tips<a class="anchor" aria-label="anchor" href="#tips"></a></h2>
<ul><li><p>Ctrl-click on a function will jump you to the code where the function is created. If it’s not part of this package, it’ll open an observer with information about the function as well as the package it’s from</p></li>
<li><p><code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> in code will automatically pause the code/app and let you use the terminal. Great for testing shiny apps.</p></li>
<li><p><a href="https://mastering-shiny.org/" class="external-link uri">https://mastering-shiny.org/</a></p></li>
</ul></div>
<div class="section level2">
<h2 id="future-considerations">Future considerations<a class="anchor" aria-label="anchor" href="#future-considerations"></a></h2>
<div class="section level3">
<h3 id="interactive-plots">Interactive Plots<a class="anchor" aria-label="anchor" href="#interactive-plots"></a></h3>
<p>Right now we use the static plots created by fasstr and then <em>add</em> interactivity to these plots with either ggiraph (adding/replacing interactive geoms) or with plotly (ggplotly). In the future, interactivity <em>could</em> be added to fasstr plots, however, there is the risk of making it necessary to update the fasstr app when all you to do is tweak something in fasstrshiny. It would also require more dependencies in fasstr.</p>
</div>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by Steffi LaZerte, Jon Goetz.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer></div>

  


  

  </body></html>

